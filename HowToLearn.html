<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PreMed Learning Science Lab | UW-Parkside</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --uwp-green: #016836;
      --uwp-black: #21272a;
      --uwp-dark-green: #00502f;
      --uwp-cool-grey: #dbd9d6;
      --uwp-goldenrod: #faba31;
      --uwp-white-birch: #efece2;
      --uwp-accent-prairie-fire: #ff4500;

      --bg: #f8fafc;
      --ink: #111827;
      --muted: #4b5563;

      --card-bg: #ffffff;
      --card-border: #e5e7eb;

      --btn-primary-bg: var(--uwp-green);
      --btn-primary-text: #ffffff;
      --btn-secondary-bg: #ffffff;
      --btn-secondary-text: var(--uwp-green);

      --progress-track: var(--uwp-cool-grey);
      --progress-bar: var(--uwp-green);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, var(--uwp-white-birch), #ffffff);
      color: var(--ink);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header, footer {
      padding: 0.4rem 0.6rem;
      color: #ffffff;
    }

    header {
      background: linear-gradient(90deg, var(--uwp-dark-green), var(--uwp-green));
      border-bottom: 3px solid var(--uwp-goldenrod);
    }

    footer {
      background: var(--uwp-black);
      border-top: 3px solid var(--uwp-green);
      margin-top: auto;
      font-size: 0.8rem;
    }

    .shell {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    main {
      flex: 1;
      padding: 0.4rem;
      display: flex;
      justify-content: center;
    }

    .view {
      display: none;
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
    }
    .view.active {
      display: block;
    }

    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: 0.02em;
      margin: 0;
    }
    h1 { font-size: 1.2rem; }
    h2 { font-size: 1.15rem; color: var(--uwp-black); margin-bottom: 0.25rem; }
    h3 { font-size: 1rem; color: var(--uwp-dark-green); margin: 0.25rem 0; }
    p { line-height: 1.35; margin: 0.25rem 0; }

    .subline {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-top: 0.15rem;
    }

    /* Progress */
    .progress-shell {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      max-width: 280px;
      margin-left: 0.25rem;
    }
    .progress-track {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: var(--progress-track);
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: var(--progress-bar);
      transition: width 0.3s ease;
    }
    .progress-label {
      font-size: 0.7rem;
      white-space: nowrap;
    }

    /* Buttons */
    .btn {
      border-radius: 999px;
      padding: 0.35rem 0.8rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      border: 1px solid transparent;
      font-weight: 500;
      transition: background 0.1s ease, color 0.1s ease, border-color 0.1s ease, transform 0.08s ease;
      margin: 0;
    }
    .btn-primary {
      background: var(--btn-primary-bg);
      color: var(--btn-primary-text);
      border-color: rgba(0,0,0,0.1);
    }
    .btn-primary:hover {
      background: var(--uwp-dark-green);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: var(--btn-secondary-bg);
      color: var(--btn-secondary-text);
      border-color: var(--uwp-green);
    }
    .btn-secondary:hover {
      background: var(--uwp-green);
      color: #ffffff;
      transform: translateY(-1px);
    }
    .btn-danger {
      background: #ff0000;
      color: #ffffff;
      border-color: #ff0000;
    }
    .btn-danger:hover {
      background: #ffffff;
      color: #000000;
      border-color: #ff0000;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
    }

    /* Cards & layout */
    .card {
      background: var(--card-bg);
      border-radius: 0.6rem;
      border: 1px solid var(--card-border);
      padding: 0.7rem 0.8rem;
      box-shadow: 0 4px 10px rgba(33, 39, 42, 0.06);
      margin-bottom: 0.4rem;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(230px,1fr));
      gap: 0.4rem;
      margin-top: 0.25rem;
    }

    .meta {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid var(--uwp-green);
      color: var(--uwp-green);
      background: #ffffff;
    }
    .chip.completed {
      background: var(--uwp-green);
      color: #ffffff;
    }

    textarea, input, select {
      width: 100%;
      border-radius: 0.4rem;
      border: 1px solid #cbd5e1;
      padding: 0.45rem 0.5rem;
      background: #ffffff;
      color: #000000;
      font-size: 0.9rem;
      resize: vertical;
      font-family: inherit;
      margin: 0;
    }
    textarea { min-height: 120px; }

    label {
      display: block;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #000000;
      margin-bottom: 0.15rem;
    }

    .field { margin-bottom: 0.4rem; }

    .pill-nav {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      margin-bottom: 0.35rem;
    }

    .observation-box {
      background: var(--uwp-white-birch);
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0.6rem;
      font-style: italic;
      color: #111827;
      margin-bottom: 0.35rem;
    }

    .explanation-box {
      background: #f0f9ff;
      border-left: 3px solid var(--uwp-green);
      border-radius: 0.3rem;
      padding: 0.5rem 0.6rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .banner {
      border-left: 3px solid var(--uwp-green);
      padding-left: 0.5rem;
    }

    .hidden { display: none !important; }

    footer .shell {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.2rem;
    }

    @media (max-width: 640px) {
      .shell {
        flex-direction: column;
        align-items: flex-start;
      }
      .progress-shell {
        margin-left: 0;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="shell">
      <div style="display:flex;align-items:center;gap:0.4rem;">
        <div style="width:26px;height:26px;border-radius:50%;border:2px solid var(--uwp-goldenrod);display:flex;align-items:center;justify-content:center;font-size:0.75rem;background:#ffffff10;">
          UWP
        </div>
        <div>
          <h1>PreMed Learning Science Lab</h1>
          <div class="subline">University of Wisconsin–Parkside | Evidence-based study experiments.</div>
        </div>
      </div>
      <div class="progress-shell" aria-label="Overall progress">
        <div class="progress-track" aria-hidden="true">
          <div class="progress-bar" id="globalProgressBar"></div>
        </div>
        <div class="progress-label" id="globalProgressLabel">0% complete</div>
      </div>
      <div style="display:flex;gap:0.35rem;">
        <button class="btn btn-secondary" id="exportBtn" type="button">Export</button>
        <button class="btn btn-danger" id="resetBtn" type="button">Reset</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Landing -->
    <div class="view active" id="view-landing" aria-labelledby="landingTitle">
      <div class="card stack">
        <div class="banner">
          <h2 id="landingTitle">When hard work does not match your exam scores</h2>
          <p>
            You put in the hours—highlighting, rereading, rewriting. The pages look neat, the effort feels
            real, and it seems like the right thing to do. But when the exam asks you to recall concepts
            from scratch, the results do not match the time you invested.
          </p>
          <p>
            This lab, designed for PreMed students at UW–Parkside, turns you into a scientist of your own
            learning. In ten short experiments, you will contrast your study habits with cognitive science
            research, make predictions, and run small trials in your real courses.
          </p>
        </div>
        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;align-items:center;">
          <button class="btn btn-primary" type="button" data-nav="dashboard">
            Begin your study transformation
          </button>
          <button class="btn btn-secondary" type="button" data-nav="roadmap">
            Peek at the roadmap
          </button>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="view" id="view-dashboard" aria-labelledby="dashboardTitle">
      <div class="card stack">
        <div>
          <h2 id="dashboardTitle">Your experiment deck</h2>
          <p class="meta">
            Complete experiments in any order. Each takes about 10–15 minutes and ends with a concrete
            change you can test in a real UWP course.
          </p>
        </div>
        <div class="dashboard-grid">
          <article class="card" data-experiment-card="activerecallarena">
            <h3>Active Recall Arena</h3>
            <p class="meta" style="color:#ffffff;background:#016836;padding:0.2rem 0.4rem;border-radius:0.3rem;">
              Retrieval practice vs rereading. In this experiment, you will compare your instincts about
              studying to data from controlled experiments.
            </p>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.4rem;">
              <span class="chip" id="chip-activerecallarena">Not started</span>
              <button class="btn btn-secondary" type="button" data-open-experiment="activerecallarena">
                Open
              </button>
            </div>
          </article>

          <article class="card">
            <h3>Spacing vs Cramming</h3>
            <p class="meta">Placeholder for a future experiment on distributed vs massed practice.</p>
          </article>
          <article class="card">
            <h3>Interleaving Gauntlet</h3>
            <p class="meta">Placeholder for a future experiment on mixed vs blocked practice sets.</p>
          </article>
        </div>
      </div>
    </div>

    <!-- Experiment -->
    <div class="view" id="view-experiment" aria-labelledby="experimentTitle">
      <div class="pill-nav">
        <button class="btn btn-secondary" type="button" data-nav="dashboard">
          &larr; Back to dashboard
        </button>
      </div>
      <div class="card stack">
        <header>
          <h2 id="experimentTitle">Active Recall Arena</h2>
          <p class="meta" style="color:#ffffff;background:#016836;padding:0.2rem 0.4rem;border-radius:0.3rem;">
            Retrieval practice vs rereading. In this experiment, you will compare your instincts about
            studying to data from controlled experiments.
          </p>
        </header>

        <!-- PHASE 1: Recognition & Reflection -->
        <section aria-labelledby="phase1Title">
          <h3 id="phase1Title">Phase 1 — Recognition vs recall</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> Before we dive into research, we want to hear from you. 
            Many students feel they study "correctly" but still struggle on exams. This phase asks you to honestly 
            reflect on your own experience—what you do, how it feels, and what results you get. There are no right 
            or wrong answers here; this is your baseline.
          </div>
          <div class="observation-box">
            "My go-to study method is to read my notes and the textbook over and over. It feels comfortable and 
            familiar, and after a few passes, I start to recognize the material. But when I'm in the exam and 
            have to write down answers from scratch, I freeze. I realize I never actually practiced retrieving 
            the information on my own. I've been recognizing things instead of really learning them, and my C 
            grades show it."
          </div>
          <div class="field">
            <label for="reflectionText">Pause for personal reflection</label>
            <p class="meta" style="color:#000000;">
              Think about your last major exam. How did you prepare? How did it feel in the moment? What
              actually happened on the test? Try to write a minimum of 50 words.
            </p>
            <textarea id="reflectionText" placeholder="Type your honest reflection here..."></textarea>
            <div class="meta" id="reflectionMeta">0 / 50 words</div>
          </div>
          <button class="btn btn-primary" type="button" id="reflectionContinueBtn" disabled>
            I have reflected — continue
          </button>
        </section>

        <!-- PHASE 2: Curiosity -->
        <section id="phase2" class="hidden" aria-labelledby="phase2Title">
          <h3 id="phase2Title">Phase 2 — Curiosity</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> Good science starts with genuine curiosity. Now that 
            you've reflected on your habits, we present a simple "what if" question that students often wonder 
            about but rarely test systematically. This curiosity question will guide the rest of our investigation.
          </div>
          <p>
            Curiosity question: <strong>What would happen if I tested myself on the material instead of
            just rereading it?</strong>
          </p>
          <button class="btn btn-primary" type="button" id="curiosityContinueBtn">
            Continue to research question
          </button>
        </section>

        <!-- PHASE 3: Research Question -->
        <section id="phase3" class="hidden" aria-labelledby="phase3Title">
          <h3 id="phase3Title">Phase 3 — Research Question</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> Scientists turn curiosity into testable research questions. 
            A good research question is precise, measurable, and focuses on comparing two clear conditions. Here's 
            how researchers framed your "what if" as a formal question they could actually study in experiments.
          </div>
          <p>
            Research question: <strong>Does retrieval practice (self-testing) produce better long-term
            retention than repeated rereading when studying course material?</strong>
          </p>
          <button class="btn btn-primary" type="button" id="researchContinueBtn">
            Continue to hypothesis
          </button>
        </section>

        <!-- PHASE 4: Hypothesis -->
        <section id="phase4" class="hidden" aria-labelledby="phase4Title">
          <h3 id="phase4Title">Phase 4 — Hypothesis</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> A hypothesis is an educated guess about what the answer 
            will be, stated in terms of variables. The <strong>Independent Variable (IV)</strong> is what we 
            manipulate (retrieval practice vs rereading). The <strong>Dependent Variable (DV)</strong> is what 
            we measure (test performance). <strong>Control Variables (CV)</strong> are what we keep the same 
            (study time, materials) so we know any difference is due to the IV, not other factors.
          </div>
          <p>
            Hypothesis: <strong>Retrieval practice</strong> (IV: independent variable) leads to higher 
            <strong>delayed test performance</strong> (DV: dependent variable) than repeated rereading (IV) 
            when <strong>study time and materials are held constant</strong> (CV: control variables).
          </p>
          <button class="btn btn-primary" type="button" id="hypothesisContinueBtn">
            Continue to prediction
          </button>
        </section>

        <!-- PHASE 5: Prediction (If...Then) -->
        <section id="phase5" class="hidden" aria-labelledby="phase5Title">
          <h3 id="phase5Title">Phase 5 — Your Prediction (If...Then)</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> Before we show you the research results, we want YOUR 
            prediction. An "If...Then" prediction forces you to commit to an expected outcome. This creates 
            cognitive engagement—you'll be more invested in seeing whether you were right or surprised. Be honest 
            about what you actually think will happen.
          </div>
          <p>
            If-then prediction: <strong>If I use retrieval practice (self-testing) instead of repeated 
            rereading while keeping study time constant (CV), then my exam performance (DV) will be 
            significantly higher.</strong>
          </p>
          <div class="field">
            <label for="predictionChoice">Which strategy do you predict will win on a delayed test?</label>
            <select id="predictionChoice">
              <option value="">Select your prediction…</option>
              <option value="rereading">Repeated rereading will do better</option>
              <option value="retrieval">Retrieval practice will do better</option>
              <option value="same">They will be about the same</option>
            </select>
          </div>
          <div class="field">
            <label for="predictionConfidence">How confident are you in this prediction? (1–5)</label>
            <input id="predictionConfidence" type="number" min="1" max="5" />
          </div>
          <button class="btn btn-primary" type="button" id="predictionContinueBtn" disabled>
            Lock in my prediction
          </button>
        </section>

        <!-- PHASE 6: Experimental Design -->
        <section id="phase6" class="hidden" aria-labelledby="phase6Title">
          <h3 id="phase6Title">Phase 6 — Experimental Design</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> Now we show you exactly how researchers tested this 
            question. Pay attention to how they set up the comparison—what each group did, what they measured, 
            and what they controlled. This is the recipe that produced the evidence you're about to see.
          </div>
          <p><strong>The Study (Roediger & Karpicke, 2006):</strong></p>
          <p>
            Students study a prose passage. One group <strong>reads the passage four times</strong> (IV: massed 
            reading). Another group <strong>reads once, then takes three practice tests with no feedback</strong> 
            (IV: retrieval practice). Both groups spend <em>equal study time</em> (CV). One week later, all 
            students take a <strong>final retention test</strong> (DV) with short-answer questions about the passage.
          </p>
          <button class="btn btn-primary" type="button" id="designContinueBtn">
            Show me the results
          </button>
        </section>

        <!-- PHASE 7: Results & Data -->
        <section id="phase7" class="hidden" aria-labelledby="phase7Title">
          <h3 id="phase7Title">Phase 7 — The Results</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> Here's what actually happened when researchers ran this 
            experiment. The numbers are real data from the study. Compare them to your prediction. Were you right? 
            Surprised? This is where science either confirms or challenges our intuitions.
          </div>
          <p><strong>Raw Data (Delayed Test Performance):</strong></p>
          <ul>
            <li>Repeated reading group: <strong>40% correct</strong></li>
            <li>Retrieval practice group: <strong>61% correct</strong></li>
          </ul>
          <p><strong>Interpretation:</strong></p>
          <p>
            Retrieval practice outperforms rereading by <strong>21 percentage points</strong> on delayed tests 
            when study time is matched. This is a large, practically meaningful effect. Students who actively 
            recalled information—even without feedback—retained significantly more one week later than students 
            who simply read the same material multiple times.
          </p>
          <p><strong>Conclusion: Hypothesis ACCEPTED.</strong></p>
          <p>
            Retrieval practice produces better long-term retention than repeated rereading.
          </p>
          <button class="btn btn-primary" type="button" id="resultsContinueBtn">
            Plan my personal experiment
          </button>
        </section>

        <!-- PHASE 8: Personal Application -->
        <section id="phase8" class="hidden" aria-labelledby="phase8Title">
          <h3 id="phase8Title">Phase 8 — Personal Application & Commitment</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> Research only matters if it changes what you do. Now you'll 
            design your own mini-experiment to test this strategy in your actual coursework. Be specific about what 
            you'll do differently, how you'll measure success, and when you'll check your results. This turns 
            knowledge into action.
          </div>
          <p><strong>What This Means for YOU:</strong></p>
          <p>
            In practical terms, this means: stop rereading your notes over and over. Instead, close your materials 
            and practice retrieving—write out what you remember, draw diagrams from memory, explain concepts aloud. 
            The time investment is the same, but the approach forces your brain to actively reconstruct knowledge 
            rather than passively recognize it. That discomfort you feel? That's learning.
          </p>
          
          <div class="field">
            <label for="expCourse">Which course will you test this in?</label>
            <input id="expCourse" type="text" placeholder="e.g., Biology 101, Organic Chemistry" />
          </div>
          <div class="field">
            <label for="expMaterial">What specific material?</label>
            <input id="expMaterial" type="text" placeholder="e.g., Chapter 7 on cell respiration" />
          </div>
          <div class="field">
            <label for="expChange">What will you do differently?</label>
            <textarea id="expChange" placeholder="Instead of [old habit], I will [new strategy]..."></textarea>
          </div>
          <div class="field">
            <label for="expMeasure">How will you measure success?</label>
            <input id="expMeasure" type="text" placeholder="e.g., quiz score, ability to explain without notes" />
          </div>
          <div class="field">
            <label for="expStart">When will you start?</label>
            <input id="expStart" type="date" />
          </div>
          <div class="field">
            <label for="expEval">When will you evaluate results?</label>
            <input id="expEval" type="date" />
          </div>
          <div class="field">
            <label>
              <input type="checkbox" id="expCommit" style="width:auto;margin-right:0.3rem;" />
              I commit to trying this experiment
            </label>
          </div>
          <button class="btn btn-primary" type="button" id="commitContinueBtn" disabled>
            Save my experiment design
          </button>
        </section>

        <!-- PHASE 9: Deep Dive -->
        <section id="phase9" class="hidden" aria-labelledby="phase9Title">
          <h3 id="phase9Title">Phase 9 — Deep Dive Resource</h3>
          <div class="explanation-box">
            <strong>What this phase is about:</strong> Want to go deeper? Here are the original peer-reviewed 
            studies and teaching resources. You don't have to read them all now, but they're here if you want 
            to understand the methodology, see additional experiments, or cite this research in your own work.
          </div>
          <p><strong>Read the Full Research:</strong></p>
          <ul>
            <li><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC9781761/" target="_blank" rel="noopener">Broad 2022 review on students' knowledge and use of retrieval practice</a></li>
            <li><a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC3983480/" target="_blank" rel="noopener">Retrieval practice enhances new learning: the forward effect of testing</a></li>
          </ul>
          <p><strong>Key Takeaways:</strong></p>
          <ul>
            <li>Retrieval practice strengthens memory more than passive review, even without immediate feedback</li>
            <li>The "testing effect" is one of the most robust findings in cognitive psychology</li>
            <li>Benefits persist weeks and months later—exactly what you need for cumulative exams like the MCAT</li>
            <li>Self-testing works across content types: facts, concepts, procedures, and applications</li>
            <li>Most students underestimate how much retrieval practice helps and overestimate rereading</li>
          </ul>
          <button class="btn btn-primary" type="button" id="deepDiveContinueBtn">
            Mark experiment complete
          </button>
        </section>

        <!-- COMPLETION MESSAGE -->
        <section id="phaseComplete" class="hidden">
          <div style="background:#d1fae5;border:1px solid #059669;border-radius:0.5rem;padding:1rem;text-align:center;">
            <h3 style="color:#065f46;margin-bottom:0.5rem;">✓ Experiment Complete!</h3>
            <p style="color:#047857;">
              You've completed the Active Recall Arena experiment. Your reflections and experiment design 
              have been saved. Return to the dashboard to continue your journey.
            </p>
            <button class="btn btn-primary" type="button" data-nav="dashboard" style="margin-top:0.5rem;">
              Return to dashboard
            </button>
          </div>
        </section>
      </div>
    </div>

    <!-- Roadmap -->
    <div class="view" id="view-roadmap" aria-labelledby="roadmapTitle">
      <div class="card stack">
        <h2 id="roadmapTitle">Your future study roadmap</h2>
        <p>
          After you complete all ten experiments, this space will help you design a weekly schedule built
          around your peak time of day, evidence-based 50-minute sessions, and a 1-3-7-14-30 spacing
          rhythm.
        </p>
        <p class="meta">
          For now, this is a placeholder so you can wire up navigation and localStorage. The final version
          will read from your experiment data to generate UWP-specific recommendations and handouts you can
          share in Canvas.
        </p>
      </div>
    </div>
  </main>

  <footer>
    <div class="shell">
      <div>
        Your inputs are stored only in your browser via localStorage. No accounts, no tracking, and no data
        is sent to a server.
      </div>
      <div style="font-size:0.75rem;">
        Designed for UW–Parkside students using official Parkside colors to support a consistent learning
        experience.
      </div>
    </div>
  </footer>

  <script>
    const STORAGE_KEY = "premedStudyLab";

    const defaultState = {
      experiments: {
        activerecallarena: {
          id: "activerecallarena",
          completed: false,
          personalReflection: "",
          reflectionWordCount: 0,
          predictionChoice: "",
          predictionConfidence: "",
          experimentDesign: {
            course: "",
            material: "",
            change: "",
            measure: "",
            start: "",
            eval: ""
          },
          completedDate: null
        }
      },
      roadmap: {
        peakTime: "",
        scheduleTemplate: "",
        lastGenerated: null
      },
      lastViewedExperimentId: null,
      progressPercentage: 0
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return { ...structuredClone(defaultState), ...parsed };
      } catch (e) {
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      updateGlobalProgressUI();
      updateExperimentChips();
    }

    let state = loadState();

    const views = {
      landing: document.getElementById("view-landing"),
      dashboard: document.getElementById("view-dashboard"),
      experiment: document.getElementById("view-experiment"),
      roadmap: document.getElementById("view-roadmap")
    };

    function showView(name) {
      Object.entries(views).forEach(([key, el]) => {
        el.classList.toggle("active", key === name);
      });
      if (name === "experiment" && state.lastViewedExperimentId === "activerecallarena") {
        hydrateExperimentUI();
      }
    }

    document.querySelectorAll("[data-nav]").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-nav");
        showView(target);
      });
    });

    document.querySelectorAll("[data-open-experiment]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-open-experiment");
        state.lastViewedExperimentId = id;
        saveState();
        showView("experiment");
      });
    });

    const progressBar = document.getElementById("globalProgressBar");
    const progressLabel = document.getElementById("globalProgressLabel");

    function recomputeProgress() {
      const experiments = Object.values(state.experiments);
      if (!experiments.length) return 0;
      const completed = experiments.filter(e => e.completed).length;
      return Math.round((completed / experiments.length) * 100);
    }

    function updateGlobalProgressUI() {
      state.progressPercentage = recomputeProgress();
      const pct = state.progressPercentage || 0;
      progressBar.style.width = pct + "%";
      progressLabel.textContent = pct + "% complete";
    }

    function updateExperimentChips() {
      const exp = state.experiments.activerecallarena;
      const chip = document.getElementById("chip-activerecallarena");
      if (!chip || !exp) return;
      if (exp.completed) {
        chip.textContent = "Completed";
        chip.classList.add("completed");
      } else if (exp.personalReflection || exp.predictionChoice) {
        chip.textContent = "In progress";
        chip.classList.remove("completed");
      } else {
        chip.textContent = "Not started";
        chip.classList.remove("completed");
      }
    }

    const reflectionTextEl = document.getElementById("reflectionText");
    const reflectionMetaEl = document.getElementById("reflectionMeta");
    const reflectionContinueBtn = document.getElementById("reflectionContinueBtn");
    const phase2El = document.getElementById("phase2");
    const phase3El = document.getElementById("phase3");
    const phase4El = document.getElementById("phase4");
    const phase5El = document.getElementById("phase5");
    const phase6El = document.getElementById("phase6");
    const phase7El = document.getElementById("phase7");
    const phase8El = document.getElementById("phase8");
    const phase9El = document.getElementById("phase9");
    const phaseCompleteEl = document.getElementById("phaseComplete");
    
    const predictionChoiceEl = document.getElementById("predictionChoice");
    const predictionConfidenceEl = document.getElementById("predictionConfidence");
    const predictionContinueBtn = document.getElementById("predictionContinueBtn");

    function countWords(str) {
      return (str.trim().match(/\S+/g) || []).length;
    }

    function hydrateExperimentUI() {
      const exp = state.experiments.activerecallarena;
      if (!exp) return;

      reflectionTextEl.value = exp.personalReflection || "";
      reflectionMetaEl.textContent = (exp.reflectionWordCount || 0) + " / 50 words";
      
      if ((exp.reflectionWordCount || 0) >= 50) {
        reflectionContinueBtn.disabled = false;
        phase2El.classList.remove("hidden");
      } else {
        reflectionContinueBtn.disabled = true;
        phase2El.classList.add("hidden");
      }

      predictionChoiceEl.value = exp.predictionChoice || "";
      predictionConfidenceEl.value = exp.predictionConfidence || "";
      
      document.getElementById("expCourse").value = exp.experimentDesign.course || "";
      document.getElementById("expMaterial").value = exp.experimentDesign.material || "";
      document.getElementById("expChange").value = exp.experimentDesign.change || "";
      document.getElementById("expMeasure").value = exp.experimentDesign.measure || "";
      document.getElementById("expStart").value = exp.experimentDesign.start || "";
      document.getElementById("expEval").value = exp.experimentDesign.eval || "";
      
      validatePredictionInputs();
    }

    reflectionTextEl.addEventListener("input", () => {
      const text = reflectionTextEl.value;
      const words = countWords(text);
      reflectionMetaEl.textContent = words + " / 50 words";
      const exp = state.experiments.activerecallarena;
      exp.personalReflection = text;
      exp.reflectionWordCount = words;
      reflectionContinueBtn.disabled = words < 50;
      saveState();
    });

    reflectionContinueBtn.addEventListener("click", () => {
      phase2El.classList.remove("hidden");
      phase2El.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("curiosityContinueBtn").addEventListener("click", () => {
      phase3El.classList.remove("hidden");
      phase3El.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("researchContinueBtn").addEventListener("click", () => {
      phase4El.classList.remove("hidden");
      phase4El.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("hypothesisContinueBtn").addEventListener("click", () => {
      phase5El.classList.remove("hidden");
      phase5El.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    function validatePredictionInputs() {
      const choice = predictionChoiceEl.value;
      const conf = predictionConfidenceEl.value;
      const confNum = Number(conf);
      const ok = choice && conf && confNum >= 1 && confNum <= 5;
      predictionContinueBtn.disabled = !ok;
      return ok;
    }

    predictionChoiceEl.addEventListener("change", () => {
      const exp = state.experiments.activerecallarena;
      exp.predictionChoice = predictionChoiceEl.value;
      saveState();
      validatePredictionInputs();
    });

    predictionConfidenceEl.addEventListener("input", () => {
      const exp = state.experiments.activerecallarena;
      exp.predictionConfidence = predictionConfidenceEl.value;
      saveState();
      validatePredictionInputs();
    });

    predictionContinueBtn.addEventListener("click", () => {
      phase6El.classList.remove("hidden");
      phase6El.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("designContinueBtn").addEventListener("click", () => {
      phase7El.classList.remove("hidden");
      phase7El.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("resultsContinueBtn").addEventListener("click", () => {
      phase8El.classList.remove("hidden");
      phase8El.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    function validateExperimentDesign() {
      const exp = state.experiments.activerecallarena;
      const design = exp.experimentDesign;
      const commit = document.getElementById("expCommit").checked;
      const allFilled = design.course && design.material && design.change && 
                       design.measure && design.start && design.eval && commit;
      document.getElementById("commitContinueBtn").disabled = !allFilled;
      return allFilled;
    }

    ["expCourse", "expMaterial", "expChange", "expMeasure", "expStart", "expEval"].forEach(id => {
      document.getElementById(id).addEventListener("input", (e) => {
        const exp = state.experiments.activerecallarena;
        const field = id.replace("exp", "").toLowerCase();
        exp.experimentDesign[field] = e.target.value;
        saveState();
        validateExperimentDesign();
      });
    });

    document.getElementById("expCommit").addEventListener("change", () => {
      validateExperimentDesign();
    });

    document.getElementById("commitContinueBtn").addEventListener("click", () => {
      phase9El.classList.remove("hidden");
      phase9El.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("deepDiveContinueBtn").addEventListener("click", () => {
      const exp = state.experiments.activerecallarena;
      exp.completed = true;
      exp.completedDate = new Date().toISOString().split('T')[0];
      saveState();
      phaseCompleteEl.classList.remove("hidden");
      phaseCompleteEl.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      const ok = confirm("This will clear all saved reflections and progress on this device. Continue?");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      state = loadState();
      updateGlobalProgressUI();
      updateExperimentChips();
      hydrateExperimentUI();
      showView("landing");
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      const exp = state.experiments.activerecallarena;
      let text = "PreMed Learning Science Lab – Reflections Export (UW–Parkside)\n\n";
      text += "Active Recall Arena\n";
      text += "--------------------\n";
      text += "Personal reflection:\n" + (exp.personalReflection || "[none]") + "\n\n";
      text += "Prediction choice: " + (exp.predictionChoice || "[none]") + "\n";
      text += "Prediction confidence (1–5): " + (exp.predictionConfidence || "[none]") + "\n\n";
      text += "Experiment Design:\n";
      text += "Course: " + (exp.experimentDesign.course || "[none]") + "\n";
      text += "Material: " + (exp.experimentDesign.material || "[none]") + "\n";
      text += "Change: " + (exp.experimentDesign.change || "[none]") + "\n";
      text += "Success measure: " + (exp.experimentDesign.measure || "[none]") + "\n";
      text += "Start date: " + (exp.experimentDesign.start || "[none]") + "\n";
      text += "Evaluation date: " + (exp.experimentDesign.eval || "[none]") + "\n";
      
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "uwp-premed-study-lab-reflections.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    updateGlobalProgressUI();
    updateExperimentChips();
    if (state.lastViewedExperimentId === "activerecallarena") {
      hydrateExperimentUI();
      showView("experiment");
    }
  </script>
</body>
</html>
