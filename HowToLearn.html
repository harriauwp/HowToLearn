<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PreMed Learning Science Lab | UW-Parkside</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --uwp-green: #016836;
      --uwp-black: #21272;
      --uwp-dark-green: #00502f;
      --uwp-cool-grey: #dbd9d6;
      --uwp-goldenrod: #faba31;
      --uwp-white-birch: #efece2;
      --uwp-accent-prairie-fire: #ff4500;

      --bg: #f8fafc;
      --ink: #111827;
      --muted: #4b5563;

      --card-bg: #ffffff;
      --card-border: #e5e7eb;

      --btn-primary-bg: var(--uwp-green);
      --btn-primary-text: #ffffff;
      --btn-secondary-bg: #ffffff;
      --btn-secondary-text: var(--uwp-green);

      --progress-track: var(--uwp-cool-grey);
      --progress-bar: var(--uwp-green);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, var(--uwp-white-birch), #ffffff);
      color: var(--ink);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header, footer {
      padding: 0.4rem 0.6rem;
      color: #ffffff;
    }

    header {
      background: linear-gradient(90deg, var(--uwp-dark-green), var(--uwp-green));
      border-bottom: 3px solid var(--uwp-goldenrod);
    }

    footer {
      background: var(--uwp-black);
      border-top: 3px solid var(--uwp-green);
      margin-top: auto;
      font-size: 0.8rem;
    }

    .shell {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    main {
      flex: 1;
      padding: 0.4rem;
      display: flex;
      justify-content: center;
    }

    .view {
      display: none;
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
    }
    .view.active {
      display: block;
    }

    h1, h2, h3 {
      font-weight: 600;
      letter-spacing: 0.02em;
      margin: 0;
    }
    h1 { font-size: 1.2rem; }
    h2 { font-size: 1.15rem; color: var(--uwp-black); margin-bottom: 0.25rem; }
    h3 { font-size: 1rem; color: var(--uwp-dark-green); margin: 0.25rem 0; }
    p { line-height: 1.35; margin: 0.25rem 0; }

    .subline {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-top: 0.15rem;
    }

    /* Progress */
    .progress-shell {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.35rem;
      max-width: 280px;
      margin-left: 0.25rem;
    }
    .progress-track {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: var(--progress-track);
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: var(--progress-bar);
      transition: width 0.3s ease;
    }
    .progress-label {
      font-size: 0.7rem;
      white-space: nowrap;
    }

    /* Buttons */
    .btn {
      border-radius: 999px;
      padding: 0.35rem 0.8rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      border: 1px solid transparent;
      font-weight: 500;
      transition: background 0.1s ease, color 0.1s ease, border-color 0.1s ease, transform 0.08s ease;
      margin: 0;
    }
    .btn-primary {
      background: var(--btn-primary-bg);
      color: var(--btn-primary-text);
      border-color: rgba(0,0,0,0.1);
    }
    .btn-primary:hover {
      background: var(--uwp-dark-green);
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: var(--btn-secondary-bg);
      color: var(--btn-secondary-text);
      border-color: var(--uwp-green);
    }
    .btn-secondary:hover {
      background: var(--uwp-green);
      color: #ffffff;
      transform: translateY(-1px);
    }
    /* Reset styling per request */
    .btn-danger {
      background: #ff0000;
      color: #ffffff;
      border-color: #ff0000;
    }
    .btn-danger:hover {
      background: #ffffff;
      color: #000000;
      border-color: #ff0000;
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
    }

    /* Cards & layout */
    .card {
      background: var(--card-bg);
      border-radius: 0.6rem;
      border: 1px solid var(--card-border);
      padding: 0.7rem 0.8rem;
      box-shadow: 0 4px 10px rgba(33, 39, 42, 0.06);
      margin-bottom: 0.4rem;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(230px,1fr));
      gap: 0.4rem;
      margin-top: 0.25rem;
    }

    .meta {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid var(--uwp-green);
      color: var(--uwp-green);
      background: #ffffff;
    }
    .chip.completed {
      background: var(--uwp-green);
      color: #ffffff;
    }

    textarea, input, select {
      width: 100%;
      border-radius: 0.4rem;
      border: 1px solid #cbd5f5;
      padding: 0.45rem 0.5rem;
      background: #ffffff;
      color: #000000;
      font-size: 0.9rem;
      resize: vertical;
      font-family: inherit;
      margin: 0;
    }
    textarea { min-height: 120px; }

    label {
      display: block;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #000000; /* pure black for readability */
      margin-bottom: 0.15rem;
    }

    .field { margin-bottom: 0.4rem; }

    .pill-nav {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      margin-bottom: 0.35rem;
    }

    .observation-box {
      background: var(--uwp-white-birch);
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0.6rem;
      font-style: italic;
      color: #111827;
      margin-bottom: 0.35rem;
    }

    .banner {
      border-left: 3px solid var(--uwp-green);
      padding-left: 0.5rem;
    }

    .hidden { display: none !important; }

    footer .shell {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.2rem;
    }

    /* Added styling for the procedure section */
    .procedure-table th, .procedure-table td {
        border: 1px solid var(--uwp-cool-grey);
        padding: 8px;
        text-align: left;
    }
    .procedure-table th {
        background-color: #eef2f6;
        color: var(--ink);
    }
    .procedure-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0.5rem 0;
        font-size: 0.9em;
    }

    @media (max-width: 640px) {
      .shell {
        flex-direction: column;
        align-items: flex-start;
      }
      .progress-shell {
        margin-left: 0;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="shell">
      <div style="display:flex;align-items:center;gap:0.4rem;">
        <div style="width:26px;height:26px;border-radius:50%;border:2px solid var(--uwp-goldenrod);display:flex;align-items:center;justify-content:center;font-size:0.75rem;background:#ffffff10;">
          UWP
        </div>
        <div>
          <h1>PreMed Learning Science Lab</h1>
          <div class="subline">University of Wisconsin–Parkside | Evidence-based study experiments.</div>
        </div>
      </div>
      <div class="progress-shell" aria-label="Overall progress">
        <div class="progress-track" aria-hidden="true">
          <div class="progress-bar" id="globalProgressBar"></div>
        </div>
        <div class="progress-label" id="globalProgressLabel">0% complete</div>
      </div>
      <div style="display:flex;gap:0.35rem;">
        <button class="btn btn-secondary" id="exportBtn" type="button">Export</button>
        <button class="btn btn-danger" id="resetBtn" type="button">Reset</button>
      </div>
    </div>
  </header>

  <main>
    <div class="view active" id="view-landing" aria-labelledby="landingTitle">
      <div class="card stack">
        <div class="banner">
          <h2 id="landingTitle">When hard work does not match your exam scores</h2>
          <p>
            You put in the hours—highlighting, rereading, rewriting. The pages look neat, the effort feels
            real, and it seems like the right thing to do. But when the exam asks you to recall concepts
            from scratch, the results do not match the time you invested.
          </p>
          <p>
            This lab, designed for PreMed students at UW–Parkside, turns you into a scientist of your own
            learning. In ten short experiments, you will contrast your study habits with cognitive science
            research, make predictions, and run small trials in your real courses.
          </p>
        </div>
        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;align-items:center;">
          <button class="btn btn-primary" type="button" data-nav="dashboard">
            Begin your study transformation
          </button>
          <button class="btn btn-secondary" type="button" data-nav="roadmap">
            Peek at the roadmap
          </button>
        </div>
      </div>
    </div>

    <div class="view" id="view-dashboard" aria-labelledby="dashboardTitle">
      <div class="card stack">
        <div>
          <h2 id="dashboardTitle">Your experiment deck</h2>
          <p class="meta">
            Complete experiments in any order. Each takes about 10–15 minutes and ends with a concrete
            change you can test in a real UWP course.
          </p>
        </div>
        <div class="dashboard-grid">
          <article class="card" data-experiment-card="activerecallarena">
            <h3>Active Recall Arena</h3>
            <p class="meta" style="color:#ffffff;background:#016836;padding:0.2rem 0.4rem;border-radius:0.3rem;">
              Retrieval practice vs rereading. In this experiment, you will compare your instincts about
              studying to data from controlled experiments.
            </p>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.4rem;">
              <span class="chip" id="chip-activerecallarena">Not started</span>
              <button class="btn btn-secondary" type="button" data-open-experiment="activerecallarena">
                Open
              </button>
            </div>
          </article>

          <article class="card">
            <h3>Spacing vs Cramming</h3>
            <p class="meta">Placeholder for a future experiment on distributed vs massed practice.</p>
          </article>
          <article class="card">
            <h3>Interleaving Gauntlet</h3>
            <p class="meta">Placeholder for a future experiment on mixed vs blocked practice sets.</p>
          </article>
        </div>
      </div>
    </div>

    <div class="view" id="view-experiment" aria-labelledby="experimentTitle">
      <div class="pill-nav">
        <button class="btn btn-secondary" type="button" data-nav="dashboard">
          &larr; Back to dashboard
        </button>
      </div>
      <div class="card stack">
        <header>
          <h2 id="experimentTitle">Active Recall Arena</h2>
          <p class="meta" style="color:#ffffff;background:#016836;padding:0.2rem 0.4rem;border-radius:0.3rem;">
            Retrieval practice vs rereading. In this experiment, you will compare your instincts about
            studying to data from controlled experiments.
          </p>
        </header>

        <section aria-labelledby="phase1Title">
          <h3 id="phase1Title">Phase 1: Observation</h3>
          <p class="meta" style="color:#000000; font-style: italic;">
            Explanation: This is your initial, personal reflection on your current study habits and academic performance. It is the necessary starting point for the scientific process, providing the real-world problem that this experiment will attempt to solve using learning science.
          </p>
          <div class="observation-box">
            “My go-to study method is to read my notes and the textbook over and over. It feels comfortable and familiar, and after a few passes, I start to recognize the material. But when I'm in the exam and have to write down answers from scratch, I freeze. I realize I never actually practiced retrieving the information on my own. I've been recognizing things instead of really learning them, and my C grades show it.”
          </div>
          <div class="field">
            <label for="reflectionText">Pause for personal reflection</label>
            <p class="meta" style="color:#000000;">
              Think about your last major exam. How did you prepare? How did it feel in the moment? What
              actually happened on the test? (a minimum of 50 words)
            </p>
            <textarea id="reflectionText" placeholder="Type your honest reflection here..."></textarea>
            <div class="meta" id="reflectionMeta">0 / 50 words</div>
          </div>
          <button class="btn btn-primary" type="button" id="reflectionContinueBtn" disabled>
            I have reflected — continue
          </button>
        </section>

        <section id="phase2plus" aria-labelledby="phase2Title">
          <h3 id="phase2Title">Phase 2: Curiosity</h3>
          <p class="meta" style="color:#000000; font-style: italic;">
            Explanation: Curiosity is a broad, open-ended question that emerges directly from the core of your personal observation. It explores the *why*—the underlying reason your current study method (rereading/recognition) is failing to produce the desired outcome (good grades/retrieval).
          </p>
          <p>
            Example Curiosity Question: *Why does the comfortable feeling of simply recognizing material during study sessions not translate into the ability to recall that information on a high-stakes exam?*
          </p>
          <div class="field">
            <label for="curiosityText">Student Input Required: Please input your own Curiosity Question based on your observation (a minimum of 50 words):</label>
            <textarea id="curiosityText" placeholder="Enter your Curiosity Question here..."></textarea>
            <div class="meta" id="curiosityMeta">0 / 50 words</div>
          </div>
          <button class="btn btn-primary" type="button" id="curiosityContinueBtn" disabled>
            Lock in my Curiosity Question
          </button>
        </section>

        <section id="phase3plus" aria-labelledby="phase3Title">
          <h3 id="phase3Title">Phase 3: Research Question</h3>
          <p class="meta" style="color:#000000; font-style: italic;">
            Explanation: The Research Question is a specific, focused, and testable refinement of your broad Curiosity. It guides the design of the experiment by asking for a measurable comparison between two different conditions. For this experiment, we compare your current method (Rereading) against the alternative suggested by the learning science literature (Retrieval Practice).
          </p>
          <p>
            <strong>Research Question:</strong> Is **retrieval practice (active recall)** a more effective study method for long-term retention and performance on exams requiring written answers than **repeated rereading (passive study)**?
          </p>

          <button class="btn btn-primary" type="button" id="researchQuestionContinueBtn">
            I understand the Research Question — continue
          </button>
        </section>

        <section id="phase4plus" aria-labelledby="phase4Title">
          <h3 id="phase4Title">Phase 4: Critical Hypothesis</h3>
          <p class="meta" style="color:#000000; font-style: italic;">
            Explanation: A hypothesis is an educated, testable prediction that attempts to answer the research question. It identifies the Independent Variable (the study method) and the Dependent Variable (the test score) and posits a clear relationship. The *critical* part is predicting which method will be *more* effective.
          </p>
          <p>
            <strong>Your Hypothesis:</strong> The use of **retrieval practice (active recall)** will result in a significantly better delayed test performance and higher retention than the use of **repeated rereading** for the same study material.
          </p>
          <div class="field">
            <label for="predictionChoice">Which strategy do you predict will win on a delayed test?</label>
            <select id="predictionChoice">
              <option value="">Select your prediction…</option>
              <option value="rereading">Repeated rereading will do better</option>
              <option value="retrieval">Retrieval practice will do better</option>
              <option value="same">They will be about the same</option>
            </select>
          </div>
          <div class="field">
            <label for="predictionConfidence">How confident are you in this prediction? (1–5)</label>
            <input id="predictionConfidence" type="number" min="1" max="5" />
          </div>
          <button class="btn btn-primary" type="button" id="predictionContinueBtn" disabled>
            Lock in my Hypothesis
          </button>
        </section>

        <section id="phase5plus" aria-labelledby="phase5Title">
          <h3 id="phase5Title">Phase 5: (If....Then) Prediction</h3>
          <p class="meta" style="color:#000000; font-style: italic;">
            Explanation: The final prediction is a precise, measurable statement of the expected outcome of the experiment, assuming your Hypothesis is correct. It links the action taken in the study to the data you expect to see.
          </p>
          <p>
            <strong>Prediction:</strong> **If** a student studies one set of flashcards using **retrieval practice** and a matching set of flashcards using **repeated rereading**, **then** the student will score a **higher percentage** on a final test for the retrieval practice material than for the rereading material.
          </p>
          
          <h3 style="margin-top: 1.5rem;">Experiment Design & Procedure</h3>
          <p>The goal is now to test this prediction using a controlled, randomized study method.</p>

          <h4>Design</h4>
          <table class="procedure-table">
              <thead>
                  <tr>
                      <th>Group</th>
                      <th>Study Method (Independent Variable)</th>
                      <th>Expected Outcome (Dependent Variable)</th>
                  </tr>
              </thead>
              <tbody>
                  <tr>
                      <td>**Control**</td>
                      <td>Repeated Rereading (Your current method)</td>
                      <td>Lower score/freezing</td>
                  </tr>
                  <tr>
                      <td>**Treatment**</td>
                      <td>Retrieval Practice (Active Recall)</td>
                      <td>Higher score/better recall</td>
                  </tr>
              </tbody>
          </table>
          
          <h4>Procedure</h4>
          <ol style="padding-left: 20px;">
              <li>**Preparation:** Divide the study material (e.g., 20 complex terms from a textbook chapter, two different historical timelines) into **Set A** and **Set B** of equal length and perceived difficulty.</li>
              <li>**Control (Rereading):** Study **Set A** by reading the material 4 times over a 30-minute session. Do not cover the answers or quiz yourself.</li>
              <li>**Treatment (Retrieval Practice):** Study **Set B** by reading the material once, then covering the answers and attempting to write everything you can remember from scratch for the remaining time. Repeat the recall/check/recall cycle 4 times over the same 30-minute session.</li>
              <li>**Delay:** Wait 48 hours (or 1 week, based on your course schedule) to simulate the delayed testing conditions of your observation.</li>
              <li>**Test:** Take a single, cumulative test on both Set A and Set B material. The test must require you to **write down answers from scratch** (simulating the type of exam where you freeze).</li>
              <li>**Measure:** Grade the test and calculate the percentage score for Set A (Rereading) and Set B (Retrieval Practice).</li>
          </ol>
          
          <button class="btn btn-primary" type="button" id="experimentCompleteBtn">
            I understand Experiment 1 — Continue to Data Analysis (Phase 6)
          </button>
        </section>

      </div>
    </div>

    <div class="view" id="view-roadmap" aria-labelledby="roadmapTitle">
      <div class="card stack">
        <h2 id="roadmapTitle">Your future study roadmap</h2>
        <p>
          After you complete all ten experiments, this space will help you design a weekly schedule built
          around your peak time of day, evidence-based 50‑minute sessions, and a 1‑3‑7‑14‑30 spacing
          rhythm.
        </p>
        <p class="meta">
          For now, this is a placeholder so you can wire up navigation and localStorage. The final version
          will read from your experiment data to generate UWP‑specific recommendations and handouts you can
          share in Canvas.
        </p>
      </div>
    </div>
  </main>

  <footer>
    <div class="shell">
      <div>
        Your inputs are stored only in your browser via localStorage. No accounts, no tracking, and no data
        is sent to a server.
      </div>
      <div style="font-size:0.75rem;">
        Designed for UW–Parkside students using official Parkside colors to support a consistent learning
        experience.
      </div>
    </div>
  </footer>

  <script>
    const STORAGE_KEY = "premedStudyLab";
    const WORD_COUNT_MIN = 50; 

    const defaultState = {
      experiments: {
        activerecallarena: {
          id: "activerecallarena",
          completed: false,
          personalReflection: "",
          reflectionWordCount: 0,
          curiosityQuestion: "", 
          curiosityWordCount: 0, 
          predictionChoice: "",
          predictionConfidence: "",
          completedDate: null
        }
      },
      roadmap: {
        peakTime: "",
        scheduleTemplate: "",
        lastGenerated: null
      },
      lastViewedExperimentId: null,
      progressPercentage: 0
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        // Ensure new fields are added if loading an old state
        return { ...structuredClone(defaultState), ...parsed, 
          experiments: { ...structuredClone(defaultState).experiments, ...parsed.experiments }
        };
      } catch (e) {
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      updateGlobalProgressUI();
      updateExperimentChips();
    }

    let state = loadState();

    const views = {
      landing: document.getElementById("view-landing"),
      dashboard: document.getElementById("view-dashboard"),
      experiment: document.getElementById("view-experiment"),
      roadmap: document.getElementById("view-roadmap")
    };

    function showView(name) {
      Object.entries(views).forEach(([key, el]) => {
        el.classList.toggle("active", key === name);
      });
      if (name === "experiment" && state.lastViewedExperimentId === "activerecallarena") {
        hydrateExperimentUI();
      }
    }

    document.querySelectorAll("[data-nav]").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-nav");
        showView(target);
      });
    });

    document.querySelectorAll("[data-open-experiment]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-open-experiment");
        state.lastViewedExperimentId = id;
        saveState();
        showView("experiment");
      });
    });

    const progressBar = document.getElementById("globalProgressBar");
    const progressLabel = document.getElementById("globalProgressLabel");

    function recomputeProgress() {
      const experiments = Object.values(state.experiments);
      if (!experiments.length) return 0;
      const completed = experiments.filter(e => e.completed).length;
      return Math.round((completed / experiments.length) * 100);
    }

    function updateGlobalProgressUI() {
      state.progressPercentage = recomputeProgress();
      const pct = state.progressPercentage || 0;
      progressBar.style.width = pct + "%";
      progressLabel.textContent = pct + "% complete";
    }

    function updateExperimentChips() {
      const exp = state.experiments.activerecallarena;
      const chip = document.getElementById("chip-activerecallarena");
      if (!chip || !exp) return;
      if (exp.completed) {
        chip.textContent = "Completed";
        chip.classList.add("completed");
      } else if (exp.personalReflection || exp.curiosityQuestion || exp.predictionChoice) {
        chip.textContent = "In progress";
        chip.classList.remove("completed");
      } else {
        chip.textContent = "Not started";
        chip.classList.remove("completed");
      }
    }

    const reflectionTextEl = document.getElementById("reflectionText");
    const reflectionMetaEl = document.getElementById("reflectionMeta");
    const reflectionContinueBtn = document.getElementById("reflectionContinueBtn");
    
    const curiosityTextEl = document.getElementById("curiosityText");
    const curiosityMetaEl = document.getElementById("curiosityMeta");
    const curiosityContinueBtn = document.getElementById("curiosityContinueBtn");

    const researchQuestionContinueBtn = document.getElementById("researchQuestionContinueBtn");

    const predictionChoiceEl = document.getElementById("predictionChoice");
    const predictionConfidenceEl = document.getElementById("predictionConfidence");
    const predictionContinueBtn = document.getElementById("predictionContinueBtn");
    
    const experimentCompleteBtn = document.getElementById("experimentCompleteBtn");


    function countWords(str) {
      return (str.trim().match(/\S+/g) || []).length;
    }

    function hydrateExperimentUI() {
      const exp = state.experiments.activerecallarena;
      if (!exp) return;
      
      // Phase 1: Reflection
      reflectionTextEl.value = exp.personalReflection || "";
      let words1 = countWords(exp.personalReflection || "");
      reflectionMetaEl.textContent = words1 + " / " + WORD_COUNT_MIN + " words";
      reflectionContinueBtn.disabled = words1 < WORD_COUNT_MIN;
      
      // Phase 2: Curiosity
      curiosityTextEl.value = exp.curiosityQuestion || "";
      let words2 = countWords(exp.curiosityQuestion || "");
      curiosityMetaEl.textContent = words2 + " / " + WORD_COUNT_MIN + " words";
      curiosityContinueBtn.disabled = words2 < WORD_COUNT_MIN;

      // Phase 4: Hypothesis
      predictionChoiceEl.value = exp.predictionChoice || "";
      predictionConfidenceEl.value = exp.predictionConfidence || "";
      validatePredictionInputs();
      
      // Experiment is complete if this button was previously clicked.
      if (exp.completed) {
        // Future: lock inputs if complete
      }
    }

    reflectionTextEl.addEventListener("input", () => {
      const text = reflectionTextEl.value;
      const words = countWords(text);
      reflectionMetaEl.textContent = words + " / " + WORD_COUNT_MIN + " words";
      const exp = state.experiments.activerecallarena;
      exp.personalReflection = text;
      exp.reflectionWordCount = words;
      reflectionContinueBtn.disabled = words < WORD_COUNT_MIN;
      saveState();
    });

    reflectionContinueBtn.addEventListener("click", () => {
      // Logic for moving forward is handled by the visual hierarchy now being displayed
      // We keep this to trigger state changes/saves if needed later
      saveState();
    });
    
    curiosityTextEl.addEventListener("input", () => {
      const text = curiosityTextEl.value;
      const words = countWords(text);
      curiosityMetaEl.textContent = words + " / " + WORD_COUNT_MIN + " words";
      const exp = state.experiments.activerecallarena;
      exp.curiosityQuestion = text;
      exp.curiosityWordCount = words;
      curiosityContinueBtn.disabled = words < WORD_COUNT_MIN;
      saveState();
    });

    curiosityContinueBtn.addEventListener("click", () => {
      // Logic for moving forward is handled by the visual hierarchy now being displayed
      saveState();
    });

    researchQuestionContinueBtn.addEventListener("click", () => {
      // Logic for moving forward is handled by the visual hierarchy now being displayed
      saveState();
    });

    function validatePredictionInputs() {
      const choice = predictionChoiceEl.value;
      const conf = predictionConfidenceEl.value;
      const confNum = Number(conf);
      const ok = choice && conf && confNum >= 1 && confNum <= 5;
      predictionContinueBtn.disabled = !ok;
      return ok;
    }

    predictionChoiceEl.addEventListener("change", () => {
      const exp = state.experiments.activerecallarena;
      exp.predictionChoice = predictionChoiceEl.value;
      saveState();
      validatePredictionInputs();
    });

    predictionConfidenceEl.addEventListener("input", () => {
      const exp = state.experiments.activerecallarena;
      exp.predictionConfidence = predictionConfidenceEl.value;
      saveState();
      validatePredictionInputs();
    });

    predictionContinueBtn.addEventListener("click", () => {
      // Logic for moving forward is handled by the visual hierarchy now being displayed
      saveState();
    });
    
    experimentCompleteBtn.addEventListener("click", () => {
        alert("Experiment 1 (Phases 1-5) is complete! Proceed to Phase 6: Data Collection and Analysis.");
        state.experiments.activerecallarena.completed = true;
        state.experiments.activerecallarena.completedDate = new Date().toISOString();
        saveState();
        showView("dashboard");
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      const ok = confirm("This will clear all saved reflections and progress on this device. Continue?");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      state = loadState();
      updateGlobalProgressUI();
      updateExperimentChips();
      hydrateExperimentUI();
      showView("landing");
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      const exp = state.experiments.activerecallarena;
      let text = "PreMed Learning Science Lab — Reflections Export (UW–Parkside)\n\n";
      text += "Active Recall Arena\n";
      text += "--------------------\n";
      text += "Phase 1 Reflection:\n" + (exp.personalReflection || "[none]") + "\n\n";
      text += "Phase 2 Curiosity Question:\n" + (exp.curiosityQuestion || "[none]") + "\n\n";
      text += "Phase 4 Prediction choice: " + (exp.predictionChoice || "[none]") + "\n";
      text += "Phase 4 Prediction confidence (1–5): " + (exp.predictionConfidence || "[none]") + "\n";
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "uwp-premed-study-lab-reflections.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    updateGlobalProgressUI();
    updateExperimentChips();
    if (state.lastViewedExperimentId === "activerecallarena") {
      hydrateExperimentUI();
      showView("experiment");
    }
  </script>
</body>
</html>
